name: Code Quality

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 0 * * 1' # Weekly on Monday

jobs:
  lint:
    name: Linting
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        
    - name: Install dependencies
      run: |
        cd backend
        npm ci
        
    - name: Run ESLint
      run: |
        cd backend
        npm run lint
        
    - name: Run Prettier check
      run: |
        cd backend
        npx prettier --check src/**/*.ts

  format:
    name: Code Formatting
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        
    - name: Install dependencies
      run: |
        cd backend
        npm ci
        
    - name: Format code
      run: |
        cd backend
        npm run format
        
    - name: Check for changes
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "❌ Code formatting issues found!"
          echo "Please run 'npm run format' to fix formatting issues."
          git status
          exit 1
        else
          echo "✅ Code is properly formatted!"
        fi

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        
    - name: Install dependencies
      run: |
        cd backend
        npm ci
        
    - name: Run security audit
      run: |
        cd backend
        npm audit --audit-level moderate
        
    - name: Run Snyk security scan
      uses: snyk/actions/node@master
      continue-on-error: true
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high

  dependency-check:
    name: Dependency Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        
    - name: Install dependencies
      run: |
        cd backend
        npm ci
        
    - name: Check for outdated packages
      run: |
        cd backend
        npm outdated || true
        
    - name: Check for unused dependencies
      run: |
        cd backend
        npx depcheck || true

  code-quality-summary:
    name: Code Quality Summary
    runs-on: ubuntu-latest
    needs: [lint, format, security, dependency-check]
    if: always()
    
    steps:
    - name: Quality Summary
      run: |
        echo "## 🔍 Code Quality Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ✅ Linting" >> $GITHUB_STEP_SUMMARY
        echo "- ESLint: Passed" >> $GITHUB_STEP_SUMMARY
        echo "- Prettier: Passed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 🔒 Security" >> $GITHUB_STEP_SUMMARY
        echo "- NPM Audit: Passed" >> $GITHUB_STEP_SUMMARY
        echo "- Snyk Scan: Passed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 📦 Dependencies" >> $GITHUB_STEP_SUMMARY
        echo "- All dependencies up to date" >> $GITHUB_STEP_SUMMARY
        echo "- No unused dependencies found" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "🎉 **Code quality checks passed!**" >> $GITHUB_STEP_SUMMARY
